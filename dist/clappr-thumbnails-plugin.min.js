!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@clappr/core")):"function"==typeof define&&define.amd?define(["@clappr/core"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ScrubThumbnailsPlugin=e(t.Clappr)}(this,(function(t){"use strict";function e(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function i(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function r(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var o,r=n(t);if(e){var s=n(this).constructor;o=Reflect.construct(r,arguments,s)}else o=r.apply(this,arguments);return i(this,o)}}var s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var a=function(t){var e={exports:{}};return t(e,e.exports),e.exports}((function(t,e){!function(t){var n=t.Promise,o=n&&"resolve"in n&&"reject"in n&&"all"in n&&"race"in n&&function(){var t;return new n((function(e){t=e})),"function"==typeof t}();e?(e.Promise=o?n:T,e.Polyfill=T):o||(t.Promise=T);var i="pending",r="sealed",s="fulfilled",a="rejected",u=function(){};function h(t){return"[object Array]"===Object.prototype.toString.call(t)}var c,l="undefined"!=typeof setImmediate?setImmediate:setTimeout,d=[];function f(){for(var t=0;t<d.length;t++)d[t][0](d[t][1]);d=[],c=!1}function p(t,e){d.push([t,e]),c||(c=!0,l(f,0))}function m(t){var e=t.owner,n=e.state_,o=e.data_,i=t[n],r=t.then;if("function"==typeof i){n=s;try{o=i(o)}catch(t){v(r,t)}}b(r,o)||(n===s&&_(r,o),n===a&&v(r,o))}function b(t,e){var n;try{if(t===e)throw new TypeError("A promises callback cannot return that same promise.");if(e&&("function"==typeof e||"object"==typeof e)){var o=e.then;if("function"==typeof o)return o.call(e,(function(o){n||(n=!0,e!==o?_(t,o):g(t,o))}),(function(e){n||(n=!0,v(t,e))})),!0}}catch(e){return n||v(t,e),!0}return!1}function _(t,e){t!==e&&b(t,e)||g(t,e)}function g(t,e){t.state_===i&&(t.state_=r,t.data_=e,p(C,t))}function v(t,e){t.state_===i&&(t.state_=r,t.data_=e,p(k,t))}function y(t){var e=t.then_;t.then_=void 0;for(var n=0;n<e.length;n++)m(e[n])}function C(t){t.state_=s,y(t)}function k(t){t.state_=a,y(t)}function T(t){if("function"!=typeof t)throw new TypeError("Promise constructor takes a function argument");if(this instanceof T==!1)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[],function(t,e){function n(t){v(e,t)}try{t((function(t){_(e,t)}),n)}catch(t){n(t)}}(t,this)}T.prototype={constructor:T,state_:i,then_:null,data_:void 0,then:function(t,e){var n={owner:this,then:new this.constructor(u),fulfilled:t,rejected:e};return this.state_===s||this.state_===a?p(m,n):this.then_.push(n),n.then},catch:function(t){return this.then(null,t)}},T.all=function(t){if(!h(t))throw new TypeError("You must pass an array to Promise.all().");return new this((function(e,n){var o=[],i=0;function r(t){return i++,function(n){o[t]=n,--i||e(o)}}for(var s,a=0;a<t.length;a++)(s=t[a])&&"function"==typeof s.then?s.then(r(a),n):o[a]=s;i||e(o)}))},T.race=function(t){if(!h(t))throw new TypeError("You must pass an array to Promise.race().");return new this((function(e,n){for(var o,i=0;i<t.length;i++)(o=t[i])&&"function"==typeof o.then?o.then(e,n):e(o)}))},T.resolve=function(t){return t&&"object"==typeof t&&t.constructor===this?t:new this((function(e){e(t)}))},T.reject=function(t){return new this((function(e,n){n(t)}))}}("undefined"!=typeof window?window:void 0!==s?s:"undefined"!=typeof self?self:s)}));var u=".scrub-thumbnails {\n  position: absolute;\n  bottom: 55px;\n  width: 100%;\n  -webkit-transition: opacity 0.3s ease;\n  -moz-transition: opacity 0.3s ease;\n  -o-transition: opacity 0.3s ease;\n  transition: opacity 0.3s ease; }\n  .scrub-thumbnails.hidden {\n    opacity: 0; }\n  .scrub-thumbnails .thumbnail-container {\n    display: inline-block;\n    position: relative;\n    overflow: hidden;\n    background-color: #000000; }\n    .scrub-thumbnails .thumbnail-container .thumbnail-img {\n      position: absolute;\n      width: auto; }\n  .scrub-thumbnails .spotlight {\n    background-color: #000000;\n    overflow: hidden;\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    border-color: #ffffff;\n    border-style: solid;\n    border-width: 2px; }\n    .scrub-thumbnails .spotlight img {\n      width: auto; }\n  .scrub-thumbnails .backdrop {\n    position: absolute;\n    left: 0;\n    bottom: 0;\n    right: 0;\n    background-color: #000000;\n    overflow: hidden; }\n    .scrub-thumbnails .backdrop .carousel {\n      position: absolute;\n      top: 0;\n      left: 0;\n      height: 100%;\n      white-space: nowrap; }\n      .scrub-thumbnails .backdrop .carousel img {\n        width: auto; }\n";return function(t,e){void 0===e&&(e={});var n=e.insertAt;if(t&&"undefined"!=typeof document){var o=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===n&&o.firstChild?o.insertBefore(i,o.firstChild):o.appendChild(i),i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t))}}(u),function(n){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}(l,n);var i,s,h,c=r(l);function l(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,l),(e=c.call(this,t))._thumbsLoaded=!1,e._show=!1,e._hoverPosition=0,e._oldContainer=null,e._thumbs=[],e._spotlightThumb=null,e._onThumbsLoaded=new a.Promise((function(t){e._onThumbsLoadedResolve=t})),e._buildThumbsFromOptions().then((function(){e._thumbsLoaded=!0,e._onThumbsLoadedResolve(),e._init()})).catch((function(t){throw t})),e}return i=l,h=[{key:"buildSpriteConfig",value:function(t,e,n,o,i,r,s){s=s||0;for(var a=[],u=0;u<e;u++)a.push({url:t,time:s+u*r,w:n,h:o,x:u%i*n,y:Math.floor(u/i)*o});return a}}],(s=[{key:"name",get:function(){return"scrub-thumbnails"}},{key:"attributes",get:function(){return{class:this.name}}},{key:"template",get:function(){return t.template('<% if (backdropHeight) { %>\n<div class="backdrop" style="height: <%= backdropHeight%>px;">\n\t<div class="carousel"></div>\n</div>\n<% }; %>\n<% if (spotlightHeight) { %>\n<div class="spotlight" style="height: <%= spotlightHeight%>px;"></div>\n<% }; %>\n')}},{key:"bindEvents",value:function(){t.Events.CORE_ACTIVE_CONTAINER_CHANGED&&this.listenTo(this.core,t.Events.CORE_ACTIVE_CONTAINER_CHANGED,this.rebindEvents),this.listenTo(this.core.mediaControl,t.Events.MEDIACONTROL_MOUSEMOVE_SEEKBAR,this._onMouseMove),this.listenTo(this.core.mediaControl,t.Events.MEDIACONTROL_MOUSELEAVE_SEEKBAR,this._onMouseLeave),this.listenTo(this.core.mediaControl,t.Events.MEDIACONTROL_RENDERED,this._init),this.listenTo(this.core.mediaControl,t.Events.MEDIACONTROL_CONTAINERCHANGED,this._onMediaControlContainerChanged)}},{key:"rebindEvents",value:function(){this.stopListening(),this.bindEvents()}},{key:"_bindContainerEvents",value:function(){this._oldContainer&&this.stopListening(this._oldContainer,t.Events.CONTAINER_TIMEUPDATE,this._renderPlugin),this._oldContainer=this.core.mediaControl.container,this.listenTo(this.core.mediaControl.container,t.Events.CONTAINER_TIMEUPDATE,this._renderPlugin)}},{key:"_onMediaControlContainerChanged",value:function(){this._bindContainerEvents()}},{key:"addThumbnail",value:function(t){var e=this,n=t.constructor===Array?t:[t];return this._onThumbsLoaded.then((function(){var t=n.map((function(t){return e._addThumbFromSrc(t).then((function(t){if(e._getOptions().backdropHeight){var n=e._thumbs.indexOf(t),o=e._buildImg(t,e._getOptions().backdropHeight);e._$backdropCarouselImgs.splice(n,0,o),1===e._$backdropCarouselImgs.length?e._$carousel.append(o):0===n?e._$backdropCarouselImgs[1].before(o):e._$backdropCarouselImgs[n-1].after(o)}}))}));return a.Promise.all(t).then((function(){t.length>0&&e._renderPlugin()}))}))}},{key:"removeThumbnail",value:function(t){var e=this,n=t.constructor===Array?t:[t];return this._onThumbsLoaded.then((function(){var t=!0,o=!1;return n.forEach((function(n){e._thumbs.some((function(t,o){return t.src===n&&(e._thumbs.splice(o,1),e._getOptions().backdropHeight&&(e._$backdropCarouselImgs[o].remove(),e._$backdropCarouselImgs.splice(o,1)),!0)}))?o=!0:t=!1})),o&&e._renderPlugin(),a.Promise.resolve(t)}))}},{key:"_init",value:function(){this._thumbsLoaded&&(this._$backdropCarouselImgs=[],this._createElements(),this._loadBackdrop(),this._renderPlugin())}},{key:"_getOptions",value:function(){if(!("scrubThumbnails"in this.core.options))throw"'scrubThumbnails property missing from options object.";return this.core.options.scrubThumbnails}},{key:"_appendElToMediaControl",value:function(){this.core.mediaControl.$el.find(".media-control-background").first().after(this.el)}},{key:"_onMouseMove",value:function(t){this._calculateHoverPosition(t),this._show=!0,this._renderPlugin()}},{key:"_onMouseLeave",value:function(){this._show=!1,this._renderPlugin()}},{key:"_calculateHoverPosition",value:function(t){var e=t.pageX-this.core.mediaControl.$seekBarContainer.offset().left;this._hoverPosition=Math.min(1,Math.max(e/this.core.mediaControl.$seekBarContainer.width(),0))}},{key:"_buildThumbsFromOptions",value:function(){var t=this,e=this._getOptions().thumbs.map((function(e){return t._addThumbFromSrc(e)}));return a.Promise.all(e)}},{key:"_addThumbFromSrc",value:function(t){var e=this;return new a.Promise((function(e,n){var o=new Image;o.onload=function(){e(o)},o.onerror=n,o.src=t.url})).then((function(n){var o=t.time,i=null;e._thumbs.some((function(t,e){return o<t.time&&(i=e,!0)})),null===i&&(i=e._thumbs.length);var r=i<e._thumbs.length?e._thumbs[i]:null,s=i>0?e._thumbs[i-1]:null;s&&(s.duration=o-s.time);var a=r?r.time-t.time:null,u=n.width,h=n.height,c={imageW:u,imageH:h,x:t.x||0,y:t.y||0,w:t.w||u,h:t.h||h,url:t.url,time:o,duration:a,src:t};return e._thumbs.splice(i,0,c),c}))}},{key:"_buildImg",value:function(e,n){var o=n/e.h,i=t.$("<img />").addClass("thumbnail-img").attr("src",e.url),r=t.$("<div />").addClass("thumbnail-container");return r.css("width",e.w*o),r.css("height",n),i.css({height:e.imageH*o,left:-1*e.x*o,top:-1*e.y*o}),r.append(i),r}},{key:"_loadBackdrop",value:function(){if(this._getOptions().backdropHeight)for(var t=this._$carousel,e=0;e<this._thumbs.length;e++){var n=this._buildImg(this._thumbs[e],this._getOptions().backdropHeight);this._$backdropCarouselImgs.push(n),t.append(n)}}},{key:"_updateCarousel",value:function(){if(this._getOptions().backdropHeight){var t=this._hoverPosition,e=this.core.mediaControl.container.getDuration(),n=this.core.mediaControl.container.getStartTimeOffset(),o=n+e*t,i=this._$backdrop.width(),r=this._$carousel,s=r.width(),a=this._thumbs,u=s/a.length,h=this._getThumbIndexForTime(o),c=a[h],l=c.duration;null===l&&(l=Math.max(e+n-c.time,0));var d=h*u+u*((o-c.time)/l),f=d-t*i;r.css("left",-f);for(var p=this._getOptions().backdropMaxOpacity||.6,m=this._getOptions().backdropMinOpacity||.08,b=0;b<a.length;b++){var _=u*b-d;_<0&&(_=Math.min(0,_+u));var g=Math.max(p-Math.abs(_)/(2*u),m);this._$backdropCarouselImgs[b].css("opacity",g)}}}},{key:"_updateSpotlightThumb",value:function(){if(this._getOptions().spotlightHeight){var t=this._hoverPosition,e=this.core.mediaControl.container.getDuration(),n=this.core.mediaControl.container.getStartTimeOffset()+e*t,o=this._getThumbIndexForTime(n),i=this._thumbs[o],r=this._$spotlight;this._spotlightThumb!==i&&(r.empty(),r.append(this._buildImg(i,this._getOptions().spotlightHeight)),this._spotlightThumb=i);var s=this.$el.width(),a=r.width(),u=s*t-a/2;u=Math.max(Math.min(u,s-a),0),r.css("left",u)}}},{key:"_getThumbIndexForTime",value:function(t){for(var e=this._thumbs,n=e.length-1;n>=0;n--)if(e[n].time<=t)return n;return 0}},{key:"_renderPlugin",value:function(){this._thumbsLoaded&&(this._show&&this._thumbs.length>0?(this.$el.removeClass("hidden"),this._updateCarousel(),this._updateSpotlightThumb()):this.$el.addClass("hidden"))}},{key:"_createElements",value:function(){this.$el.html(this.template({backdropHeight:this._getOptions().backdropHeight,spotlightHeight:this._getOptions().spotlightHeight})),this.$el.append(t.Styler.getStyleFor(u)),this._$spotlight=this.$el.find(".spotlight"),this._$backdrop=this.$el.find(".backdrop"),this._$carousel=this._$backdrop.find(".carousel"),this.$el.addClass("hidden"),this._appendElToMediaControl()}}])&&e(i.prototype,s),h&&e(i,h),l}(t.UICorePlugin)}));
